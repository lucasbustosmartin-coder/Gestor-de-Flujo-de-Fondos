<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión Empanadas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .sidebar { width: 80px; transition: width 0.3s; }
    .sidebar:hover { width: 240px; }
    .menu-item { padding: 12px 16px; display: flex; align-items: center; cursor: pointer; border-radius: 8px; }
    .menu-item:hover { background: #f3f4f6; }
    .menu-item span { opacity: 0; white-space: nowrap; overflow: hidden; transition: opacity 0.3s; }
    .sidebar:hover .menu-item span { opacity: 1; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 50; }
    .btn-export { background: #10b981; color: white; }
    .btn-export:hover { background: #0d9668; }
    .btn-google { background: #fff; border: 1px solid #ddd; color: #333; }
    .btn-google:hover { background: #f8f8f8; }
    #debugMsg { position: fixed; top: 10px; right: 10px; background: #000; color: #0f0; padding: 10px; border-radius: 5px; font-size: 14px; z-index: 100; max-width: 300px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex">

  <!-- Mensaje de depuración -->
  <div id="debugMsg">Cargando Supabase...</div>

  <!-- Pantalla de Login -->
  <div id="loginScreen" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl shadow-lg w-96 text-center">
      <h2 class="text-2xl font-bold mb-6">Iniciar Sesión</h2>
      <p class="text-sm text-gray-600 mb-6">Accede con tu cuenta de Google</p>
      <button id="btnGoogleLogin" class="w-full btn-google py-3 rounded flex items-center justify-center space-x-2 border">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="fill-current">
          <path d="M12.545 10.239v3.821h5.445c-0.712 2.315-2.647 3.972-5.445 3.972-3.332 0-6.033-2.701-6.033-6.032s2.701-6.032 6.033-6.032c1.498 0 2.866 0.549 3.921 1.453l2.814-2.814c-1.792-1.603-4.152-2.551-6.735-2.551-5.42 0-9.827 4.407-9.827 9.827s4.407 9.828 9.827 9.828c8.072 0 9.381-6.153 9.381-9.828 0-0.479-0.049-0.891-0.074-1.014h-9.307z"/>
        </svg>
        <span>Iniciar sesión con Google</span>
      </button>
      <p id="loginError" class="text-red-600 text-sm mt-4 hidden">Error al iniciar sesión</p>
    </div>
  </div>

  <!-- Contenido Principal -->
  <div id="mainContent" class="flex-1 ml-20 p-6 hidden">
    <h1 id="headerTitle" class="text-2xl font-bold text-gray-900">¡Bienvenido!</h1>
    <button id="btnSignOut" class="mt-4 bg-red-600 text-white px-4 py-2 rounded">Cerrar sesión</button>
  </div>

  <!-- Cargar Supabase JS -->
  <script>
    // === 🔑 Cargar Supabase y esperar a que esté listo ===
    const SUPABASE_URL = 'https://moeqgzezdraknwmheheu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZXFnemV6ZHJha253bWhlaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNTY2MDgsImV4cCI6MjA3MDkzMjYwOH0.ZHIJjZv7izlaegfeypj8s6jNb0ls-LTrt914qhgO_uA';

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
    script.onload = () => {
      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
      window.supabaseClient = supabaseClient;
      iniciarApp();
    };
    document.head.appendChild(script);

    function iniciarApp() {
      const loginScreen = document.getElementById('loginScreen');
      const mainContent = document.getElementById('mainContent');
      const btnGoogleLogin = document.getElementById('btnGoogleLogin');
      const btnSignOut = document.getElementById('btnSignOut');
      const loginError = document.getElementById('loginError');
      const debugMsg = document.getElementById('debugMsg');

      async function checkSession() {
        debugMsg.textContent = 'Verificando sesión...';
        const {  session } = await supabaseClient.auth.getSession();
        
        if (session) {
          debugMsg.textContent = 'Sesión encontrada, verificando usuario...';
          const {  userData } = await supabaseClient
            .from('usuarios')
            .select('*')
            .eq('email', session.user.email)
            .single();

          if (userData) {
            debugMsg.textContent = `¡Listo! Rol: ${userData.rol}`;
            loginScreen.style.display = 'none';
            mainContent.style.display = 'block';
          } else {
            debugMsg.textContent = 'No autorizado';
            loginError.classList.remove('hidden');
            loginError.textContent = 'No tienes acceso. Contacta al admin.';
            await supabaseClient.auth.signOut();
          }
        } else {
          debugMsg.textContent = 'Sin sesión';
        }
      }

      btnGoogleLogin.addEventListener('click', async () => {
        debugMsg.textContent = 'Iniciando con Google...';
        const { error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: 'https://lucasbustosmartin-coder.github.io/Gestor-de-Flujo-de-Fondos/'
          }
        });
        if (error) {
          debugMsg.textContent = 'Error: ' + error.message;
          loginError.classList.remove('hidden');
          loginError.textContent = error.message;
        }
      });

      btnSignOut.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        location.reload();
      });

      supabaseClient.auth.onAuthStateChange(() => {
        setTimeout(checkSession, 1000);
      });

      checkSession();
    }
  </script>
</body>
</html>
